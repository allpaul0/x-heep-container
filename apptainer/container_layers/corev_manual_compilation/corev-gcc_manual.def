Bootstrap: localimage
From: container_layers/build/gcc.sif

%environment
    export COREV=/opt/tools/corev
    export PATH=${COREV}/bin:$PATH

%post
    # Set non-interactive frontend to avoid prompt
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y gcc-multilib \
    autoconf automake autotools-dev curl python3 python3-pip \
    python3-tomli libmpc-dev libmpfr-dev libgmp-dev gawk \
    build-essential bison flex texinfo gperf libtool patchutils \
    bc zlib1g-dev libexpat-dev ninja-build git cmake libglib2.0-dev libslirp-dev

    cd /opt
    # Clone the COREV GNU toolchain (including GCC, binutils, newlib, etc.)
    git clone https://github.com/openhwgroup/corev-gcc.git
    cd corev-gcc/
    git checkout cv32e40pv2-release
    # Configure for a newlib cross-compiler with prefix /opt/tools/corev
    ./configure \
        --prefix=/opt/tools/corev \
        --target=riscv32-corev-elf \
        --enable-multilib \
        --with-multilib-generator="rv32i-ilp32--;rv32ic-ilp32--;"
    # rv32im-ilp32--;rv32imc-ilp32--;rv32e-ilp32e--;rv32ec-ilp32e--;rv32em-ilp32e--;rv32emc-ilp32e--;rv32if_zicsr-ilp32f--;rv32ifc_zicsr-ilp32f--;rv32imf_zicsr-ilp32f--;rv32imfc_zicsr-ilp32f--;rv32ifd_zicsr-ilp32d--;rv32ifdc_zicsr-ilp32d--;rv32imfd_zicsr-ilp32d--;rv32imfdc_zicsr-ilp32d--;rv32im_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32--;rv32imc_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32--;rv32imf_zicsr_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32f--;rv32imfc_zicsr_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32f--;rv32imfd_zicsr_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32d--;rv32imfdc_zicsr_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32d--;rv32im_zicsr_zfinx_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32--;rv32imc_zicsr_zfinx_xcvalu_xcvbi_xcvbitmanip_xcvhwlp_xcvmac_xcvmem_xcvsimd-ilp32--;"
    # Build the toolchain (this will build GCC, binutils, newlib, etc.)
    make -j$(nproc)
    make install